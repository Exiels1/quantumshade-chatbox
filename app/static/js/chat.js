const socket = io();const messagesEl = document.getElementById('messages');const formEl = document.getElementById('chat-form');const inputEl = document.getElementById('chat-input');function addMessage(username, content, time=null){  const wrap = document.createElement('div');  wrap.className = 'msg';  const now = time ? new Date(time) : new Date();  const hh = now.getHours().toString().padStart(2,'0');  const mm = now.getMinutes().toString().padStart(2,'0');  wrap.innerHTML = `<span class="u">${username}</span><span class="t">${hh}:${mm}</span><div class="c"></div>`;  wrap.querySelector('.c').textContent = content;  messagesEl.appendChild(wrap);  messagesEl.scrollTop = messagesEl.scrollHeight;}if (formEl) {  formEl.addEventListener('submit', (e)=>{    e.preventDefault();    const text = inputEl.value.trim();    if(!text) return;    if(window.QS && window.QS.mode === 'dm'){      socket.emit('send_dm', { thread_id: window.QS.thread_id, text });    }else{      socket.emit('send_message', { text });    }    inputEl.value='';  });}socket.on('new_message', (data)=>{  addMessage(data.username, data.content, data.created_at);});socket.on('system', (data)=>{  addMessage('System', data.msg);});socket.on('new_dm', (data)=>{  if(window.QS && window.QS.mode === 'dm' && String(window.QS.thread_id) === String(data.thread_id)){    addMessage(data.sender, data.content, data.created_at);  }});
