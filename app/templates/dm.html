{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dm.css') }}">

<div class="qs-dm-root">

  <!-- animated lightning background -->
  <div class="qs-lightning" aria-hidden="true"></div>

  <aside class="qs-sidebar">
    <div class="qs-profile">
      <div class="qs-avatar-wrap">
        <img src="{{ current_user.avatar_url or url_for('static', filename='img/avatars/user_2.jpg') }}" alt="{{ current_user.username }}" class="qs-avatar">
        <span class="qs-avatar-glow"></span>
      </div>
      <div class="qs-user-meta">
        <div class="qs-username">{{ current_user.username or 'Guest' }}</div>
        <div class="qs-subtle">QuantumShade</div>
      </div>
    </div>

    <div class="qs-search">
      <input id="chatSearch" placeholder="Search chats..." />
    </div>

    <nav class="qs-chat-list" id="chatList" aria-label="Conversations">
      {% if chats %}
        {% for chat in chats %}
          {# chat.partner.username, chat.thread_id, chat.last_message_preview, chat.last_message_time expected #}
          <a href="{{ url_for('main.dm', username=chat.partner.username) }}"
             class="qs-chat-item {% if chat.partner.username == active_username %}active{% endif %}"
             data-thread="{{ chat.thread_id }}">
            <img class="qs-chat-avatar" src="{{ chat.partner.avatar_url or url_for('static', filename='img/avatars/user_2.jpg') }}" alt="{{ chat.partner.username }}">
            <div class="qs-chat-meta">
              <div class="qs-chat-name">{{ chat.partner.username or 'Unknown' }}</div>
              <div class="qs-chat-preview">{{ chat.last_message_preview or 'No messages yet' }}</div>
            </div>
            <div class="qs-chat-time">{{ chat.last_message_time or '' }}</div>
          </a>
        {% endfor %}
      {% else %}
        <div class="qs-no-chats">No chats available â€” start a new one.</div>
      {% endif %}
    </nav>
  </aside>

  <main class="qs-chat-panel" role="main">
    {% if active_user %}
      <header class="qs-header">
        <div class="qs-header-left">
          <div class="qs-avatar-wrap small">
            <img src="{{ active_user.avatar_url or url_for('static', filename='img/avatars/user_2.jpg') }}" alt="{{ active_user.username }}" class="qs-avatar">
            <span class="qs-online {% if active_user.status == 'Online' %}visible{% endif %}"></span>
            <span class="qs-avatar-glow small-glow"></span>
          </div>
          <div class="qs-header-info">
            <div class="qs-chat-name">{{ active_user.username or 'Unknown' }}</div>
            <div class="qs-chat-sub">{{ active_user.status or 'Offline' }}</div>
          </div>
        </div>
        <div class="qs-header-actions">
          <button id="profileBtn" class="qs-icon-btn" title="View profile">âš¡</button>
        </div>
      </header>

      <section id="chatMessages" class="qs-messages" data-thread-id="{{ thread_id }}">
        {% if messages %}
          {% for message in messages %}
            <div class="qs-message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}"
                 data-message-id="{{ message.id or '' }}">
              <div class="qs-bubble">
                <div class="qs-msg-content">{{ message.content|default('') }}</div>
                <div class="qs-msg-meta">
                  <span class="qs-time">{{ message.created_at.strftime('%H:%M') if message.created_at else '' }}</span>
                  {% if message.sender_id == current_user.id %}
                    <span class="qs-status">â—</span> {# placeholder for ticks/delivery #}
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="qs-empty-spot">No messages yet â€” say hello.</div>
        {% endif %}
      </section>

      <footer class="qs-input-bar" role="form" aria-label="Message input">
        <button id="attachBtn" class="qs-attach" title="Attach">ğŸ“</button>
        <div class="qs-input-wrap">
          <input id="messageInput" autocomplete="off" placeholder="Type a message..." />
          <div id="typingIndicator" class="qs-typing" aria-hidden="true">
            <span></span><span></span><span></span>
          </div>
        </div>
        <button id="sendBtn" class="qs-send" title="Send"><span class="qs-bolt">âš¡</span></button>
      </footer>

    {% else %}
      <div class="qs-no-active">
        <div class="qs-empty-landing">
          <h3>Pick a chat</h3>
          <p>Choose a conversation from the left to begin. QuantumShade awaits.</p>
        </div>
      </div>
    {% endif %}
  </main>
</div>

<script>
  window.CURRENT_USER = "{{ current_user.username }}";
</script>

<script src="{{ url_for('static', filename='js/dm.js') }}"></script>
{% endblock %}
